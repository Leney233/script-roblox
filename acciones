local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local playerGui = player:WaitForChild("PlayerGui")

local currentTrack = nil 
local currentAnimId = nil 

local draggingSlider = false
local currentTransparency = 0
local lastAppliedTransparency = 0 
local originalTransparencies = {} 
local mapLoaded = false 

local targetPlayer = nil 
local isTargeting = false 
local bringAllEnabled = false 

local hitboxEnabled = false
local draggingHbSlider = false
local minHitboxSize = 2   
local maxHitboxSize = 200 
local currentHitboxSize = minHitboxSize 
local TargetList = {}

local ID_TORNADO = 135373056067761
local ID_SENTARSE = 71112973269174
local misEmotes = {
	{Name = "Tornado (G)",  Id = ID_TORNADO},
	{Name = "Sentarse (F)", Id = ID_SENTARSE}
}

task.spawn(function()
	for i = 1, 10 do 
		pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.EmotesMenu, false) end)
		task.wait(0.5) 
	end
end)

local function saveOriginalState(part)
	if part:IsA("BasePart") or part:IsA("Decal") or part:IsA("Texture") then
		if originalTransparencies[part] == nil then
			originalTransparencies[part] = part.Transparency
		end
	end
end

task.spawn(function()
	wait(1) 
	for _, obj in pairs(workspace:GetDescendants()) do
		saveOriginalState(obj)
	end
	workspace.DescendantAdded:Connect(saveOriginalState)
	mapLoaded = true
end)

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "System_Final_V24_SyncFix"
screenGui.ResetOnSpawn = false
screenGui.DisplayOrder = 100
screenGui.IgnoreGuiInset = true 
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "TopContainer"
mainFrame.Size = UDim2.new(0, 110, 0, 32) 
mainFrame.Position = UDim2.new(0, 230, 0, 8) 
mainFrame.BackgroundTransparency = 1 
mainFrame.Parent = screenGui

local toggleBtn = Instance.new("TextButton")
toggleBtn.Name = "ToggleBtn"
toggleBtn.Text = "ACCIONES"
toggleBtn.Size = UDim2.new(1, 0, 1, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0) 
toggleBtn.BackgroundTransparency = 0.5
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 12 
toggleBtn.Parent = mainFrame
local btnCorner = Instance.new("UICorner"); btnCorner.CornerRadius = UDim.new(1, 0); btnCorner.Parent = toggleBtn

local listFrame = Instance.new("Frame")
listFrame.Name = "ListPanel"
listFrame.Size = UDim2.new(1, 10, 0, 0) 
listFrame.Position = UDim2.new(0, -5, 0, 38) 
listFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
listFrame.BackgroundTransparency = 0.2
listFrame.Visible = false 
listFrame.ZIndex = 10 
listFrame.Parent = mainFrame
local listCorner = Instance.new("UICorner"); listCorner.CornerRadius = UDim.new(0, 8); listCorner.Parent = listFrame
local layout = Instance.new("UIListLayout"); layout.Parent = listFrame; layout.HorizontalAlignment = Enum.HorizontalAlignment.Center; layout.SortOrder = Enum.SortOrder.LayoutOrder; layout.Padding = UDim.new(0, 4)
local padding = Instance.new("UIPadding"); padding.PaddingTop = UDim.new(0, 8); padding.PaddingBottom = UDim.new(0, 8); padding.Parent = listFrame

local targetFrame = Instance.new("Frame")
targetFrame.Name = "TargetInputFrame"
targetFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
targetFrame.BorderSizePixel = 0
targetFrame.Position = UDim2.new(0.5, -100, 0.85, 0) 
targetFrame.Size = UDim2.new(0, 200, 0, 35)
targetFrame.Visible = false 
targetFrame.ZIndex = 20
targetFrame.Parent = screenGui
local tBgC = Instance.new("UICorner"); tBgC.CornerRadius = UDim.new(0, 6); tBgC.Parent = targetFrame

local targetBox = Instance.new("TextBox")
targetBox.Name = "TargetBox"
targetBox.Size = UDim2.new(1, -10, 1, 0)
targetBox.Position = UDim2.new(0, 5, 0, 0)
targetBox.BackgroundTransparency = 1
targetBox.TextColor3 = Color3.new(1, 1, 1)
targetBox.PlaceholderText = "Escribe nombre parcial..."
targetBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
targetBox.Font = Enum.Font.Gotham
targetBox.TextSize = 14
targetBox.Text = ""
targetBox.ZIndex = 21
targetBox.Parent = targetFrame

local sliderBarBackground = Instance.new("Frame")
sliderBarBackground.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
sliderBarBackground.BackgroundTransparency = 0.2
sliderBarBackground.BorderSizePixel = 0
sliderBarBackground.Position = UDim2.new(0.5, -150, 0.9, -20) 
sliderBarBackground.Size = UDim2.new(0, 300, 0, 12)
sliderBarBackground.Visible = false 
sliderBarBackground.ZIndex = 20
sliderBarBackground.Parent = screenGui
local sBgC = Instance.new("UICorner"); sBgC.CornerRadius = UDim.new(1, 0); sBgC.Parent = sliderBarBackground

local sliderFill = Instance.new("Frame")
sliderFill.BackgroundColor3 = Color3.fromRGB(170, 0, 255) 
sliderFill.BorderSizePixel = 0
sliderFill.Size = UDim2.new(0, 0, 1, 0)
sliderFill.ZIndex = 21
sliderFill.Parent = sliderBarBackground
local sFilC = Instance.new("UICorner"); sFilC.CornerRadius = UDim.new(1, 0); sFilC.Parent = sliderFill

local sliderKnob = Instance.new("ImageButton")
sliderKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
sliderKnob.BorderSizePixel = 0
sliderKnob.Position = UDim2.new(0, -10, 0.5, -10)
sliderKnob.Size = UDim2.new(0, 20, 0, 20)
sliderKnob.ZIndex = 22
sliderKnob.Parent = sliderBarBackground
local skC = Instance.new("UICorner"); skC.CornerRadius = UDim.new(1, 0); skC.Parent = sliderKnob

local valueLabel = Instance.new("TextLabel")
valueLabel.BackgroundTransparency = 1
valueLabel.Position = UDim2.new(0.5, 0, -2.5, 0)
valueLabel.Size = UDim2.new(1, 0, 1, 0)
valueLabel.Font = Enum.Font.GothamBold
valueLabel.Text = "Transparencia Mapa: 0%"
valueLabel.TextColor3 = Color3.new(1, 1, 1)
valueLabel.TextStrokeTransparency = 0.5
valueLabel.TextSize = 16
valueLabel.ZIndex = 20
valueLabel.Parent = sliderBarBackground

local hbSliderBg = Instance.new("Frame")
hbSliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
hbSliderBg.BackgroundTransparency = 0.2
hbSliderBg.BorderSizePixel = 0
hbSliderBg.Position = UDim2.new(0.5, -150, 0.82, -20) 
hbSliderBg.Size = UDim2.new(0, 300, 0, 12)
hbSliderBg.Visible = false 
hbSliderBg.ZIndex = 20
hbSliderBg.Parent = screenGui
local hbBgC = Instance.new("UICorner"); hbBgC.CornerRadius = UDim.new(1, 0); hbBgC.Parent = hbSliderBg

local hbSliderFill = Instance.new("Frame")
hbSliderFill.BackgroundColor3 = Color3.fromRGB(0, 200, 255) 
hbSliderFill.BorderSizePixel = 0
hbSliderFill.Size = UDim2.new(0, 0, 1, 0) 
hbSliderFill.ZIndex = 21
hbSliderFill.Parent = hbSliderBg
local hbFilC = Instance.new("UICorner"); hbFilC.CornerRadius = UDim.new(1, 0); hbFilC.Parent = hbSliderFill

local hbKnob = Instance.new("ImageButton")
hbKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
hbKnob.BorderSizePixel = 0
hbKnob.Position = UDim2.new(0, -10, 0.5, -10)
hbKnob.Size = UDim2.new(0, 20, 0, 20)
hbKnob.ZIndex = 22
hbKnob.Parent = hbSliderBg
local hbKC = Instance.new("UICorner"); hbKC.CornerRadius = UDim.new(1, 0); hbKC.Parent = hbKnob

local hbLabel = Instance.new("TextLabel")
hbLabel.BackgroundTransparency = 1
hbLabel.Position = UDim2.new(0.5, 0, -2.5, 0)
hbLabel.Size = UDim2.new(1, 0, 1, 0)
hbLabel.Font = Enum.Font.GothamBold
hbLabel.Text = "TamaÃ±o Hitbox: " .. minHitboxSize
hbLabel.TextColor3 = Color3.new(0.6, 1, 1)
hbLabel.TextStrokeTransparency = 0.5
hbLabel.TextSize = 16
hbLabel.ZIndex = 20
hbLabel.Parent = hbSliderBg

local function findTarget(text)
	text = text:lower()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player then
			if p.Name:lower():sub(1, #text) == text or p.DisplayName:lower():sub(1, #text) == text then
				return p
			end
		end
	end
	return nil
end

local function restorePlayerPhysics(p)
	if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
		local root = p.Character.HumanoidRootPart
		root.CanCollide = true
		root.Massless = false
		root.Transparency = 1
		root.Size = Vector3.new(2, 2, 1)
		if root:FindFirstChild("TargetVis") then root.TargetVis:Destroy() end
		if root:FindFirstChild("BringAllVis") then root.BringAllVis:Destroy() end
		if root:FindFirstChild("HitboxVisualizer") then root.HitboxVisualizer:Destroy() end
	end
end

local function restoreAllPhysics()
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player then restorePlayerPhysics(p) end
	end
end

targetBox.FocusLost:Connect(function(enterPressed)
	if enterPressed then
		local found = findTarget(targetBox.Text)
		if found then
			targetPlayer = found
			isTargeting = true
			targetBox.Text = "Objetivo: " .. found.Name
			targetBox.TextColor3 = Color3.fromRGB(0, 255, 0) 
		else
			targetPlayer = nil
			isTargeting = false
			targetBox.Text = "No encontrado"
			targetBox.TextColor3 = Color3.fromRGB(255, 0, 0) 
			wait(1)
			targetBox.Text = ""
			targetBox.TextColor3 = Color3.new(1,1,1)
		end
	end
end)

RunService.RenderStepped:Connect(function()
	if draggingSlider then
		local barPos = sliderBarBackground.AbsolutePosition
		local barSize = sliderBarBackground.AbsoluteSize
		local relativeX = math.clamp(mouse.X - barPos.X, 0, barSize.X)
		local percentage = relativeX / barSize.X
		sliderKnob.Position = UDim2.new(percentage, -10, 0.5, -10)
		sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
		currentTransparency = percentage
		valueLabel.Text = "Transparencia Mapa: " .. math.floor(percentage * 100) .. "%"
	end
	
	if draggingHbSlider then
		local barPos = hbSliderBg.AbsolutePosition
		local barSize = hbSliderBg.AbsoluteSize
		local relativeX = math.clamp(mouseX - barPos.X, 0, barSize.X)
		local percentage = relativeX / barSize.X
		local newSize = minHitboxSize + ((maxHitboxSize - minHitboxSize) * percentage)
		currentHitboxSize = newSize
		hbKnob.Position = UDim2.new(percentage, -10, 0.5, -10)
		hbSliderFill.Size = UDim2.new(percentage, 0, 1, 0)
		hbLabel.Text = "TamaÃ±o Hitbox: " .. math.floor(newSize)
	end
	
	if mapLoaded and math.abs(currentTransparency - lastAppliedTransparency) > 0.01 then
		lastAppliedTransparency = currentTransparency
		for part, original in pairs(originalTransparencies) do
			if part and part.Parent then
				if not (player.Character and part:IsDescendantOf(player.Character)) then
					part.Transparency = math.max(original, currentTransparency)
				end
			else
				originalTransparencies[part] = nil
			end
		end
	end
	
	if isTargeting and targetPlayer and targetPlayer.Character then
		local root = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
		local myChar = player.Character
		local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
		
		if root and myRoot then
			root.Size = Vector3.new(5, 5, 5)
			root.Transparency = 0.5
			root.CanCollide = false
			root.Massless = true
			
			local box = root:FindFirstChild("TargetVis")
			if not box then
				box = Instance.new("SelectionBox")
				box.Name = "TargetVis"
				box.Adornee = root
				box.Parent = root
				box.Color3 = Color3.fromRGB(255, 0, 0) 
			end
			
			root.CFrame = myRoot.CFrame * CFrame.new(0, 0, -3) 
		end
	elseif targetPlayer == nil and isTargeting == true then
		isTargeting = false
		targetBox.Text = "Jugador saliÃ³"
	end

	if bringAllEnabled then
		local myChar = player.Character
		local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
		if myRoot then
			for _, p in ipairs(Players:GetPlayers()) do
				if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
					local root = p.Character.HumanoidRootPart
					
					root.Size = Vector3.new(5, 5, 5)
					root.Transparency = 0.5
					root.CanCollide = false
					root.Massless = true
					
					local box = root:FindFirstChild("BringAllVis")
					if not box then
						box = Instance.new("SelectionBox")
						box.Name = "BringAllVis"
						box.Adornee = root
						box.Parent = root
						box.Color3 = Color3.fromRGB(170, 0, 255) 
					end
					
					root.CFrame = myRoot.CFrame * CFrame.new(0, 0, -4) 
				end
			end
		end
	end
	
	if hitboxEnabled then
		local targetVector = Vector3.new(currentHitboxSize, currentHitboxSize, currentHitboxSize)
		for _, p in ipairs(Players:GetPlayers()) do
			if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
				local rootPart = p.Character.HumanoidRootPart
				
				rootPart.Size = targetVector
				rootPart.Transparency = 0.5 
				rootPart.BrickColor = BrickColor.new("Really blue")
				rootPart.Material = Enum.Material.Plastic 
				rootPart.CanCollide = false 
				rootPart.CanTouch = true    
				rootPart.CanQuery = true    
				rootPart.Massless = true    
				
				local box = rootPart:FindFirstChild("HitboxVisualizer")
				if not box then
					box = Instance.new("SelectionBox")
					box.Name = "HitboxVisualizer"
					box.Adornee = rootPart
					box.Parent = rootPart
				end
				box.Color3 = Color3.fromRGB(0, 170, 255)
				box.LineThickness = 0.05
				box.SurfaceTransparency = 1 
			end
		end
	end
end)

local function stopCurrent()
	if currentTrack then currentTrack:Stop(); currentTrack = nil end
end

local function toggleAnim(animId)
	stopCurrent()
	if currentAnimId == animId then currentAnimId = nil; return end
	currentAnimId = animId
	local char = player.Character; if not char then return end
	local hum = char:FindFirstChild("Humanoid"); if not hum then return end
	local animator = hum:FindFirstChild("Animator") or Instance.new("Animator", hum)
	local animation = Instance.new("Animation"); animation.AnimationId = "rbxassetid://"..tostring(animId)
	local s, t = pcall(function() return animator:LoadAnimation(animation) end)
	if s and t then currentTrack = t; t.Priority = Enum.AnimationPriority.Action; t.Looped = true; t:Play() end
end

local function killScript()
	stopCurrent()
	bringAllEnabled = false
	isTargeting = false
	hitboxEnabled = false
	restoreAllPhysics()
	
	if mapLoaded then
		for part, original in pairs(originalTransparencies) do
			if part and part.Parent then part.Transparency = original end
		end
	end
	screenGui:Destroy()
	script:Destroy()
end

local function createButton(text, color, order, callback)
	local btn = Instance.new("TextButton")
	btn.Text = text
	btn.Size = UDim2.new(0.9, 0, 0, 30) 
	btn.BackgroundColor3 = color
	btn.BackgroundTransparency = 0.3
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Font = Enum.Font.GothamSemibold
	btn.TextSize = 11
	btn.LayoutOrder = order
	btn.ZIndex = 11
	btn.Parent = listFrame
	local uc = Instance.new("UICorner"); uc.CornerRadius = UDim.new(0, 6); uc.Parent = btn
	btn.MouseButton1Click:Connect(callback)
	return btn
end

for i, data in ipairs(misEmotes) do
	createButton(data.Name, Color3.fromRGB(60, 60, 70), i, function() toggleAnim(data.Id) end)
end

createButton("TRANSPARENCIA MAPA", Color3.fromRGB(120, 40, 200), 50, function()
	sliderBarBackground.Visible = not sliderBarBackground.Visible
end)

local hitboxBtn = createButton("HITBOX (OFF)", Color3.fromRGB(0, 180, 200), 55, function()
	if not hitboxEnabled then
		hitboxEnabled = true
		hbSliderBg.Visible = true
	else
		hitboxEnabled = false
		hbSliderBg.Visible = false
		restoreAllPhysics()
	end
end)

local targetBtn = createButton("TARGET HITBOX", Color3.fromRGB(255, 100, 0), 60, function()
	if bringAllEnabled then return end 
	targetFrame.Visible = not targetFrame.Visible
	if not targetFrame.Visible then
		isTargeting = false
		targetPlayer = nil
		targetBox.Text = ""
		restoreAllPhysics()
	else
		targetBox:CaptureFocus()
	end
end)

local bringAllBtn = createButton("BRING ALL (OFF)", Color3.fromRGB(160, 32, 240), 65, function()
	bringAllEnabled = not bringAllEnabled
	if bringAllEnabled then
		isTargeting = false 
		targetFrame.Visible = false
	else
		restoreAllPhysics()
	end
end)

RunService.RenderStepped:Connect(function()
	if hitboxEnabled then
		hitboxBtn.Text = "HITBOX (ON)"
		hitboxBtn.BackgroundColor3 = Color3.fromRGB(0, 220, 150)
	else
		hitboxBtn.Text = "HITBOX (OFF)"
		hitboxBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 200) 
	end

	if isTargeting then
		targetBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0) 
		targetBtn.Text = "ATACANDO: " .. (targetPlayer and targetPlayer.Name or "...")
	else
		targetBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 0) 
		targetBtn.Text = "TARGET HITBOX"
	end
	
	if bringAllEnabled then
		bringAllBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
		bringAllBtn.Text = "BRING ALL (ON)"
	else
		bringAllBtn.BackgroundColor3 = Color3.fromRGB(160, 32, 240)
		bringAllBtn.Text = "BRING ALL (OFF)"
	end
end)

createButton("ðŸ’€ CERRAR TODO", Color3.fromRGB(200, 30, 30), 100, killScript)

listFrame.Size = UDim2.new(1, 10, 0, (#misEmotes + 5) * 34 + 20)

toggleBtn.MouseButton1Click:Connect(function()
	listFrame.Visible = not listFrame.Visible
	if listFrame.Visible then toggleBtn.Text = "CERRAR" else toggleBtn.Text = "ACCIONES" end
end)

sliderKnob.MouseButton1Down:Connect(function() draggingSlider = true end)
hbKnob.MouseButton1Down:Connect(function() draggingHbSlider = true end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then 
		draggingSlider = false
		draggingHbSlider = false
	end
end)

UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.X then sliderBarBackground.Visible = not sliderBarBackground.Visible end
	if input.KeyCode == Enum.KeyCode.F then toggleAnim(ID_SENTARSE) 
	elseif input.KeyCode == Enum.KeyCode.G then toggleAnim(ID_TORNADO) 
	end
	
	if input.KeyCode == Enum.KeyCode.C then
		if bringAllEnabled then return end
		targetFrame.Visible = not targetFrame.Visible
		if not targetFrame.Visible then
			isTargeting = false
			targetPlayer = nil
			targetBox.Text = ""
			restoreAllPhysics()
		else
			targetBox:CaptureFocus()
		end
	end
end)
